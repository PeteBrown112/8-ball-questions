<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wasteland 8‑Ball Question Generator</title>
  <style>
    :root{
      --bg:#0a0f0a;
      --panel:#0e1710;
      --text:#d6ffd8;
      --muted:#86b88c;
      --glow:#39ff6a;
      --amber:#ffd54a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(57,255,106,.10), rgba(0,0,0,0) 55%),
        radial-gradient(900px 700px at 10% 60%, rgba(255,213,74,.08), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, #060906, var(--bg));
      min-height:100vh;
    }

    /* CRT scanlines + vignette */
    .crt::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background: linear-gradient(to bottom, rgba(255,255,255,.05), rgba(0,0,0,0) 2px);
      background-size: 100% 4px;
      opacity:.09;
      mix-blend-mode: overlay;
    }
    .crt::after{
      content:"";
      position:fixed;
      inset:-10vh -10vw;
      pointer-events:none;
      background: radial-gradient(circle at 50% 40%, rgba(0,0,0,0) 40%, rgba(0,0,0,.55) 78%);
      opacity:.9;
    }

    /* Loading screen (generic retro-terminal; no trademarks/graphics) */
    .loading{
      position:fixed;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      background:
        radial-gradient(900px 700px at 50% 10%, rgba(57,255,106,.12), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, #050705, #030403);
      z-index:9999;
    }
    .loadCard{
      width:min(860px, 92vw);
      border:2px solid rgba(255,213,74,.25);
      border-radius:18px;
      padding:18px 18px 16px;
      background:
        linear-gradient(180deg, rgba(80,55,25,.35), rgba(10,15,10,.85)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0 2px, rgba(0,0,0,0) 2px 9px);
      box-shadow: 0 24px 70px rgba(0,0,0,.70);
      position:relative;
      overflow:hidden;
    }
    .loadTitle{
      text-transform:uppercase;
      letter-spacing:1.2px;
      font-weight:900;
      margin:0 0 8px;
      font-size: 22px;
      text-shadow: 0 0 12px rgba(57,255,106,.22);
    }
    .loadSub{
      margin:0 0 14px;
      color:var(--muted);
      font-size: 12px;
      line-height:1.35;
    }
    .bar{
      height: 12px;
      border-radius:999px;
      border:1px solid rgba(57,255,106,.22);
      background: rgba(0,0,0,.28);
      overflow:hidden;
      box-shadow: inset 0 0 18px rgba(0,0,0,.65);
    }
    .bar > div{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(57,255,106,.0), rgba(57,255,106,.7), rgba(255,213,74,.55));
      box-shadow: 0 0 16px rgba(57,255,106,.18);
      transition: width .25s ease;
    }
    .loadLine{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }
    .blink{ animation: blink 1s steps(1) infinite; }
    @keyframes blink { 50%{ opacity: .35; } }

    .wrap{ max-width: 1120px; margin: 0 auto; padding: 22px 14px 48px; position:relative; }
    .frame{
      border: 2px solid #4a3a21;
      background:
        linear-gradient(180deg, rgba(80,55,25,.55), rgba(10,15,10,.88)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0 2px, rgba(0,0,0,0) 2px 8px);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size: 26px;
      letter-spacing: 1px;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(57,255,106,.18);
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(57,255,106,.22);
      background: rgba(0,0,0,.24);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: 14px;
      padding: 14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .panel{
      background: rgba(8,12,8,.72);
      border: 1px solid rgba(57,255,106,.18);
      border-radius: 16px;
      padding: 14px;
      box-shadow: inset 0 0 28px rgba(0,0,0,.55);
    }

    /* Big clickable 8-ball */
    .stage{ display:flex; justify-content:center; align-items:center; padding: 10px 0 16px; }
    .ballWrap{
      width: min(640px, 92vw);
      aspect-ratio: 1/1;
      position:relative;
      display:flex; justify-content:center; align-items:center;
      user-select:none;
    }
    .pipes{
      position:absolute;
      inset:-10px;
      border-radius: 50%;
      border: 2px dashed rgba(255,213,74,.25);
      filter: drop-shadow(0 0 10px rgba(255,213,74,.10));
      opacity:.6;
      pointer-events:none;
    }
    .ball{
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background:
        radial-gradient(220px 220px at 30% 22%, rgba(255,255,255,.18), rgba(255,255,255,0) 60%),
        radial-gradient(520px 520px at 40% 55%, #2a332a, #070b07 68%, #000 100%);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        inset 0 0 40px rgba(0,0,0,.72),
        0 22px 70px rgba(0,0,0,.65),
        0 0 24px rgba(57,255,106,.10);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      transform-origin: 50% 55%;
      animation: slowSpin 28s linear infinite;
      cursor:pointer;
      outline:none;
    }
    .ball:focus{ box-shadow:
        inset 0 0 40px rgba(0,0,0,.72),
        0 22px 70px rgba(0,0,0,.65),
        0 0 34px rgba(57,255,106,.16);
    }
    @keyframes slowSpin { to { transform: rotate(360deg); } }

    /* violent shake + dissolve reveal */
    .ball.asking{ animation: slowSpin 28s linear infinite, violent 1100ms ease-in-out; }
    @keyframes violent{
      0% { transform: rotate(0deg) translate(0,0) scale(1); }
      10%{ transform: rotate(-18deg) translate(-6px,4px) scale(1.02); }
      20%{ transform: rotate(22deg) translate(7px,-5px) scale(1.03); }
      30%{ transform: rotate(-28deg) translate(-10px,6px) scale(1.03); }
      40%{ transform: rotate(30deg) translate(11px,-7px) scale(1.04); }
      55%{ transform: rotate(-16deg) translate(-8px,4px) scale(1.03); }
      70%{ transform: rotate(14deg) translate(6px,-3px) scale(1.02); }
      85%{ transform: rotate(-10deg) translate(-4px,2px) scale(1.01); }
      100%{ transform: rotate(0deg) translate(0,0) scale(1); }
    }

    .window{
      width: 52%;
      height: 52%;
      border-radius: 50%;
      background:
        radial-gradient(170px 170px at 35% 30%, rgba(57,255,106,.22), rgba(0,0,0,0) 62%),
        radial-gradient(240px 240px at 40% 55%, #0e1f12, #070d08 75%);
      border: 1px solid rgba(57,255,106,.18);
      box-shadow:
        inset 0 0 30px rgba(0,0,0,.75),
        0 0 26px rgba(57,255,106,.10);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .eight{
      position:absolute;
      top: 5.5%;
      left: 50%;
      transform: translateX(-50%);
      width: 22%;
      aspect-ratio: 1/1;
      border-radius: 50%;
      background: rgba(245,245,245,.92);
      color:#0b0b10;
      font-weight: 900;
      font-size: clamp(22px, 4.2vw, 40px);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.55);
    }
    .triangle{
      width: 0; height: 0;
      border-left: 22% solid transparent;
      border-right: 22% solid transparent;
      border-top: 38% solid rgba(2, 8, 3, .94);
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.45));
      transform: translateY(18%);
    }
    .qText{
      position:absolute;
      top: 32%;
      left: 50%;
      transform: translateX(-50%);
      width: 64%;
      text-align:center;
      color: rgba(214,255,216,.98);
      text-shadow: 0 2px 8px rgba(0,0,0,.75);
      font-weight: 750;
      letter-spacing: .4px;
      font-size: clamp(12px, 1.55vw, 18px);
      line-height: 1.18;
      max-height: 44%;
      overflow:hidden;
      padding: 0 6px;
      opacity: 1;
      transition: opacity .22s ease;
    }
    .qText.hidden{ opacity: 0; }
    .qText.reveal{ animation: dissolve 900ms steps(12) forwards; }
    @keyframes dissolve{
      0%{ opacity: 0; filter: blur(6px) contrast(1.1); clip-path: polygon(0 0, 100% 0, 100% 0, 0 0); }
      55%{ opacity: .85; filter: blur(2px) contrast(1.2); clip-path: polygon(0 0, 100% 0, 100% 78%, 0 62%); }
      100%{ opacity: 1; filter: blur(0) contrast(1); clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); }
    }

    .row{ display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    .btn{
      border: 1px solid rgba(57,255,106,.28);
      background: rgba(0,0,0,.28);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: inset 0 0 18px rgba(0,0,0,.65);
      text-transform: uppercase;
      letter-spacing: .8px;
      font-weight: 800;
    }
    .btnCorrect{
      width:100%;
      border: 1px solid rgba(57,255,106,.45);
      background:
        radial-gradient(120px 120px at 35% 30%, rgba(255,255,255,.16), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(57,255,106,.35), rgba(0,0,0,.26));
    }

    .lever{
      display:flex; align-items:center; gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .leverTitle{ font-weight: 800; font-size: 13px; }
    .leverSub{ font-size: 11px; color: var(--muted); margin-top: 2px; }
    .lever input{
      appearance:none; width: 70px; height: 34px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      position: relative; cursor: pointer; outline:none;
      box-shadow: inset 0 0 18px rgba(0,0,0,.55);
    }
    .lever input::before{
      content:""; position:absolute; top: 50%; left: 6px;
      width: 24px; height: 24px; transform: translateY(-50%);
      border-radius: 6px;
      background: linear-gradient(180deg, rgba(255,213,74,.95), rgba(130,80,10,.92));
      box-shadow: 0 8px 18px rgba(0,0,0,.55);
      transition: left .18s ease, filter .18s ease;
    }
    .lever input:checked{
      background: rgba(57,255,106,.12);
      border-color: rgba(57,255,106,.28);
      box-shadow: inset 0 0 18px rgba(57,255,106,.10), 0 0 20px rgba(57,255,106,.08);
    }
    .lever input:checked::before{ left: 40px; filter: saturate(1.1); }

    details summary{ cursor:pointer; }
    textarea{
      width:100%;
      min-height: 140px;
      border-radius: 14px;
      border: 1px solid rgba(57,255,106,.22);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 10px;
      box-shadow: inset 0 0 18px rgba(0,0,0,.55);
    }
    .hint{ color: var(--muted); font-size: 12px; margin-top: 10px; line-height: 1.35; }
    code{ color: var(--amber); font-weight: 900; }
  
    .bg{position:fixed; inset:0; z-index:-2; background: linear-gradient(180deg,#050705,#070907);}
    .bg::before{content:""; position:absolute; inset:0; background:url("./assets/metal_panel.png") center/cover no-repeat; opacity:.35; mix-blend-mode:overlay; filter:contrast(1.05) saturate(.9);}
    .bg::after{content:""; position:absolute; inset:0; background:url("./assets/grunge_overlay.png") center/cover no-repeat; opacity:.55; mix-blend-mode:multiply;}

  </style>
</head>
<body class="crt">
  <div class="bg" aria-hidden="true"></div>

  <div class="loading" id="loading">
    <div class="loadCard">
      <h2 class="loadTitle">Initializing Wasteland Terminal</h2>
      <p class="loadSub">
        Calibrating question coils… purging static… syncing filters…<br/>
        <span class="blink">▋</span>
      </p>
      <div class="bar"><div id="barFill"></div></div>
      <div class="loadLine">
        <span id="loadMsg">Boot sequence…</span>
        <span id="loadPct">0%</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="frame">
      <div class="header">
        <h1>Wasteland 8‑Ball Questions</h1>
        <div class="row">
          <span class="pill" id="countPill">0 questions</span>
          <span class="pill" id="modePill">Mode: Random</span>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="stage">
            <div class="ballWrap">
              <div class="pipes" aria-hidden="true"></div>
              <div class="ball" id="ball" tabindex="0" role="button" aria-label="Get a new random question">
                <div class="window">
                  <div class="eight">8</div>
                  <div class="triangle"></div>
                  <div class="qText" id="qText">CLICK THE 8‑BALL FOR A QUESTION.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="justify-content:center">
            <button class="btn" id="btnCopy">COPY</button>
          </div>

          <p class="hint">Tip: 8‑ball is the “new question” control. Keyboard: Enter/Space.</p>

          <details style="margin-top:10px;">
            <summary class="pill"><strong>Optional:</strong> edit question list (one per line)</summary>
            <div style="margin-top:10px;">
              <textarea id="questionBox"></textarea>
              <div class="row" style="margin-top:10px; justify-content:flex-end">
                <button class="btn" id="btnReset">RESET LIST</button>
              </div>
            </div>
          </details>
        </div>

        <div class="panel">
          <div class="row" style="gap:12px; justify-content:space-between">
            <div class="pill">Correct: <strong id="correctCount">0</strong></div>
            <button class="btn" id="btnResetScore">RESET SCORE</button>
          </div>

          <div style="margin-top:12px;">
            <button class="btn btnCorrect" id="btnCorrect">✅ CORRECT!</button>
          </div>

          <p class="hint" id="meta" style="margin-top:12px;"></p>

          <div style="height:12px"></div>

          <div class="row" style="gap:12px">
            <div class="lever">
              <input type="checkbox" id="musicOn" checked />
              <div><div class="leverTitle">Music</div><div class="leverSub">toggle background audio</div></div>
            </div>

            <div class="lever">
              <input type="checkbox" id="filterDoYou" />
              <div><div class="leverTitle">Do you…</div><div class="leverSub">starts with “Do you”</div></div>
            </div>

            <div class="lever">
              <input type="checkbox" id="filterAdverbs" />
              <div><div class="leverTitle">Frequency</div><div class="leverSub">always / usually…</div></div>
            </div>

            <div class="lever">
              <input type="checkbox" id="filterPrefer" />
              <div><div class="leverTitle">Preference</div><div class="leverSub">prefer / rather</div></div>
            </div>

            <div class="lever">
              <input type="checkbox" id="noRepeats" />
              <div><div class="leverTitle">No repeats</div><div class="leverSub">until all used</div></div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row" style="gap:12px">
            <div class="lever">
              <input type="checkbox" id="catFood" />
              <div><div class="leverTitle">Food & Drink</div><div class="leverSub">eat / drink / breakfast…</div></div>
            </div>

            <div class="lever">
              <input type="checkbox" id="catRoutine" />
              <div><div class="leverTitle">Daily routine</div><div class="leverSub">morning / time / go to…</div></div>
            </div>

            <div class="lever">
              <input type="checkbox" id="catFeelings" />
              <div><div class="leverTitle">Feelings</div><div class="leverSub">like / feel / happy…</div></div>
            </div>
          </div>

          <p class="hint">Frequency adverbs: <code>always, usually, often, sometimes, never, ever, normally</code></p>
        </div>
      </div>
    </div>
  </div>

  <audio id="bgm" src="./bgm.mp3" preload="auto" loop></audio>

  <script src="./questions.js"></script>
  <script>
    const bgm = document.getElementById("bgm");
    bgm.volume = 0.12;

    let audioCtx = null;
    function ensureAudio(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playClick(){
      ensureAudio();
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "square";
      o.frequency.setValueAtTime(820, t);
      o.frequency.exponentialRampToValueAtTime(260, t + 0.05);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.18, t + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.07);
      o.connect(g).connect(audioCtx.destination);
      o.start(t); o.stop(t + 0.08);
    }

    function playTick(){
      ensureAudio();
      const t = audioCtx.currentTime;
      const dur = 0.015;
      const buffer = audioCtx.createBuffer(1, Math.floor(audioCtx.sampleRate * dur), audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i=0; i<data.length; i++){
        const decay = 1 - (i / data.length);
        data[i] = (Math.random()*2 - 1) * (decay * 0.9);
      }
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      const hp = audioCtx.createBiquadFilter();
      hp.type = "highpass"; hp.frequency.value = 2500;
      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.35, t + 0.002);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);
      src.connect(hp).connect(g).connect(audioCtx.destination);
      src.start(t); src.stop(t + 0.04);
    }

    let tickTimer = null;
    function startTickBurst(ms=900){
      stopTickBurst();
      const start = performance.now();
      const schedule = () => {
        const now = performance.now();
        if (now - start > ms) return stopTickBurst();
        playTick();
        tickTimer = setTimeout(schedule, 45 + Math.random()*120);
      };
      schedule();
    }
    function stopTickBurst(){
      if (tickTimer) clearTimeout(tickTimer);
      tickTimer = null;
    }

    // Loading screen
    const loading = document.getElementById("loading");
    const barFill = document.getElementById("barFill");
    const loadMsg = document.getElementById("loadMsg");
    const loadPct = document.getElementById("loadPct");
    const bootSteps = ["Boot sequence…","Linking modules…","Scanning question bank…","Sealing UI…","Stabilizing coils…","Ready."];
    let bootI = 0, pct = 0;
    function boot(){
      const iv = setInterval(() => {
        pct += 8 + Math.floor(Math.random()*10);
        if (pct > 100) pct = 100;
        barFill.style.width = pct + "%";
        loadPct.textContent = pct + "%";
        if (pct >= (bootI+1)*18 && bootI < bootSteps.length-1){
          bootI++; loadMsg.textContent = bootSteps[bootI];
        }
        if (pct === 100){
          clearInterval(iv);
          setTimeout(() => loading.style.opacity = "0"; loading.style.pointerEvents = "none"; loading.style.display = "none", 350);
        }
      }, 180);
    }

    // App logic
    const ADVERBS = ["always","usually","often","sometimes","never","ever","normally"];
    const CAT = {
      food: /\b(eat|drink|coffee|tea|water|milk|juice|breakfast|lunch|dinner|hungry|thirsty|restaurant|sandwich|cook)\b/i,
      routine: /\b(morning|afternoon|evening|night|today|tomorrow|weekend|every day|everyday|daily|time|o'?clock|get up|wake up|go to bed|school|homework|work|commute|shower)\b/i,
      feelings: /\b(like|love|hate|prefer|rather|think|feel|happy|sad|angry|tired|scared|excited|bored|good|bad)\b/i
    };

    const ball = document.getElementById("ball");
    const qText = document.getElementById("qText");
    const meta = document.getElementById("meta");

    const btnCopy = document.getElementById("btnCopy");
    const btnReset = document.getElementById("btnReset");

    const musicOn = document.getElementById("musicOn");
    const filterDoYou = document.getElementById("filterDoYou");
    const filterAdverbs = document.getElementById("filterAdverbs");
    const filterPrefer = document.getElementById("filterPrefer");
    const noRepeats = document.getElementById("noRepeats");

    const catFood = document.getElementById("catFood");
    const catRoutine = document.getElementById("catRoutine");
    const catFeelings = document.getElementById("catFeelings");

    const countPill = document.getElementById("countPill");
    const modePill = document.getElementById("modePill");
    const questionBox = document.getElementById("questionBox");

    const btnCorrect = document.getElementById("btnCorrect");
    const correctCount = document.getElementById("correctCount");
    const btnResetScore = document.getElementById("btnResetScore");

    function normalizeSpaces(s){ return (s||"").replace(/\s+/g," ").trim(); }
    function splitLinesToQuestions(text){ return (text||"").split(/\r?\n/).map(normalizeSpaces).filter(x => x.length>0); }
    function startsWithDoYouQ(q){ return normalizeSpaces(q).toLowerCase().startsWith("do you"); }
    function hasAdverb(q){ const lower=q.toLowerCase(); return ADVERBS.some(a => new RegExp("\\b"+a+"\\b","i").test(lower)); }
    function isPreferenceQ(q){ const lower=q.toLowerCase(); return lower.includes("prefer") || lower.includes("would you rather") || lower.includes("rather "); }
    function inAnySelectedCategory(q){
      const selected = [];
      if (catFood.checked) selected.push(CAT.food);
      if (catRoutine.checked) selected.push(CAT.routine);
      if (catFeelings.checked) selected.push(CAT.feelings);
      if (!selected.length) return true;
      return selected.some(rx => rx.test(q));
    }
    function shuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    const BUILT_IN = (window.A1_QUESTIONS || []).slice();
    const BANK_OK = BUILT_IN.length > 0;
    const LS = {
      list: "a1_wplus_list_v1",
      music: "a1_wplus_music_v1",
      doyou: "a1_wplus_doyou_v1",
      adv: "a1_wplus_adv_v1",
      pref: "a1_wplus_pref_v1",
      norep: "a1_wplus_norep_v1",
      catFood: "a1_wplus_cat_food_v1",
      catRoutine: "a1_wplus_cat_routine_v1",
      catFeelings: "a1_wplus_cat_feelings_v1",
      score: "a1_wplus_score_v1"
    };

    function getActiveList(){
      const edited = splitLinesToQuestions(questionBox.value);
      return edited.length ? edited : BUILT_IN.slice();
    }
    function applyFilters(list){
      return list.filter(q => {
        if (filterDoYou.checked && !startsWithDoYouQ(q)) return false;
        if (filterAdverbs.checked && !hasAdverb(q)) return false;
        if (filterPrefer.checked && !isPreferenceQ(q)) return false;
        if (!inAnySelectedCategory(q)) return false;
        return true;
      });
    }
    function tagsFor(q){
      const tags=[];
      if (startsWithDoYouQ(q)) tags.push('Do you');
      if (hasAdverb(q)) tags.push('Frequency');
      if (isPreferenceQ(q)) tags.push('Preference');
      if (CAT.food.test(q)) tags.push('Food');
      if (CAT.routine.test(q)) tags.push('Routine');
      if (CAT.feelings.test(q)) tags.push('Feelings');
      return tags;
    }

    let bag = [];
    let bagKey = "";
    function computeKey(){
      return [
        filterDoYou.checked ? "D1":"D0",
        filterAdverbs.checked ? "A1":"A0",
        filterPrefer.checked ? "P1":"P0",
        catFood.checked ? "F1":"F0",
        catRoutine.checked ? "R1":"R0",
        catFeelings.checked ? "E1":"E0",
        String(getActiveList().length)
      ].join("|");
    }
    function refreshBagIfNeeded(pool){
      const keyNow = computeKey();
      if (keyNow !== bagKey){ bagKey = keyNow; bag = shuffle(pool); }
      if (!bag.length) bag = shuffle(pool);
    }
    function pick(pool){
      if (!pool.length) return null;
      if (!noRepeats.checked) return pool[Math.floor(Math.random()*pool.length)];
      refreshBagIfNeeded(pool);
      return bag.pop() || null;
    }

    function updateCount(){
      const pool = applyFilters(getActiveList());
      countPill.textContent = `${pool.length} question${pool.length===1?"":"s"}`;
      modePill.textContent = `Mode: ${noRepeats.checked ? "No repeats" : "Random"}`;
      return pool;
    }

    function animateBall(){
      ball.classList.remove("asking");
      void ball.offsetWidth;
      ball.classList.add("asking");
      setTimeout(()=>ball.classList.remove("asking"), 1120);
    }

    function revealQuestion(text){
      qText.classList.remove("reveal");
      qText.classList.add("hidden");
      void qText.offsetWidth;
      qText.textContent = (text || "NO MATCHING QUESTIONS.").toUpperCase();
      qText.classList.remove("hidden");
      qText.classList.add("reveal");
      setTimeout(()=>qText.classList.remove("reveal"), 950);
    }

    function showMeta(q){
      if (!q){ meta.textContent = "Try turning a lever off."; return; }
      const tags = tagsFor(q);
      meta.textContent = tags.length ? `Tags: ${tags.join(" • ")}` : "";
    }

    async function copyCurrent(){
      const text = (qText.textContent || "").trim();
      if (!text || text.includes("CLICK")) return;
      try{
        await navigator.clipboard.writeText(text);
        btnCopy.textContent = "COPIED";
        setTimeout(()=>btnCopy.textContent="COPY", 900);
      } catch {
        const tmp=document.createElement("textarea");
        tmp.value=text;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        document.body.removeChild(tmp);
        btnCopy.textContent = "COPIED";
        setTimeout(()=>btnCopy.textContent="COPY", 900);
      }
    }

    function loadScore(){
      const s = parseInt(localStorage.getItem(LS.score) || "0", 10);
      correctCount.textContent = String(isNaN(s)?0:s);
    }
    function incrementScore(){
      playClick();
      const current = parseInt(correctCount.textContent || "0", 10) || 0;
      const next = current + 1;
      correctCount.textContent = String(next);
      localStorage.setItem(LS.score, String(next));
    }
    function resetScore(){
      playClick();
      correctCount.textContent = "0";
      localStorage.setItem(LS.score, "0");
    }

    function saveState(){
      localStorage.setItem(LS.list, questionBox.value);
      localStorage.setItem(LS.music, musicOn.checked ? "1":"0");
      localStorage.setItem(LS.doyou, filterDoYou.checked ? "1":"0");
      localStorage.setItem(LS.adv, filterAdverbs.checked ? "1":"0");
      localStorage.setItem(LS.pref, filterPrefer.checked ? "1":"0");
      localStorage.setItem(LS.norep, noRepeats.checked ? "1":"0");
      localStorage.setItem(LS.catFood, catFood.checked ? "1":"0");
      localStorage.setItem(LS.catRoutine, catRoutine.checked ? "1":"0");
      localStorage.setItem(LS.catFeelings, catFeelings.checked ? "1":"0");
    }

    function loadState(){
      const saved = localStorage.getItem(LS.list);
      questionBox.value = saved ? saved : BUILT_IN.join("\n");
      musicOn.checked = (localStorage.getItem(LS.music) ?? "1") === "1";
      filterDoYou.checked = localStorage.getItem(LS.doyou) === "1";
      filterAdverbs.checked = localStorage.getItem(LS.adv) === "1";
      filterPrefer.checked = localStorage.getItem(LS.pref) === "1";
      noRepeats.checked = localStorage.getItem(LS.norep) === "1";
      catFood.checked = localStorage.getItem(LS.catFood) === "1";
      catRoutine.checked = localStorage.getItem(LS.catRoutine) === "1";
      catFeelings.checked = localStorage.getItem(LS.catFeelings) === "1";
    }

    function resetBag(){ bag=[]; bagKey=""; }

    function newQuestion(){
      ensureAudio();
      if (audioCtx.state === "suspended") audioCtx.resume();
      if (musicOn.checked) bgm.play().catch(()=>{});

      playClick();
      const pool = updateCount();
    if (typeof BANK_OK !== "undefined" && !BANK_OK){
      const qt = document.getElementById("qText");
      if (qt) qt.textContent = "QUESTION BANK NOT LOADED — CHECK questions.js IS IN THE SAME FOLDER.";
    }
      animateBall();
      startTickBurst(900);

      const q = pick(pool);
      setTimeout(()=>{
        revealQuestion(q || "No matching questions.");
        showMeta(q);
        saveState();
      }, 520);
    }

    ball.addEventListener("click", newQuestion);
    // Mobile Safari sometimes prefers touch events. Ensure taps always trigger.
    ball.addEventListener("touchstart", (e) => { e.preventDefault(); newQuestion(); }, { passive: false });
    ball.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " "){
        e.preventDefault();
        newQuestion();
      }
    });

    btnCopy.addEventListener("click", ()=>{ playClick(); copyCurrent(); });
    btnReset.addEventListener("click", ()=>{
      playClick();
      questionBox.value = BUILT_IN.join("\n");
      resetBag();
      updateCount();
      revealQuestion(pick(applyFilters(getActiveList())) || "No matching questions.");
      saveState();
    });

    btnCorrect.addEventListener("click", incrementScore);
    btnResetScore.addEventListener("click", resetScore);

    const levers = [musicOn, filterDoYou, filterAdverbs, filterPrefer, noRepeats, catFood, catRoutine, catFeelings];
    levers.forEach(el=>{
      el.addEventListener("change", ()=>{
        playClick();
        resetBag();
        updateCount();
        saveState();

        if (el === musicOn){
          ensureAudio();
          if (audioCtx.state === "suspended") audioCtx.resume();
          if (musicOn.checked){
            bgm.play().catch(()=>{});
          } else {
            bgm.pause();
            bgm.currentTime = 0;
          }
        }
      });
    });

    questionBox.addEventListener("input", ()=>{ resetBag(); updateCount(); saveState(); });

    // Init
    loadState();
    loadScore();
    updateCount();
    boot();
    if (!musicOn.checked){ bgm.pause(); bgm.currentTime = 0; }
  </script>
</body>
</html>
